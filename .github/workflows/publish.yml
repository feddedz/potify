name: Video Pipeline
on:
  push:
    branches: [main]

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y yt-dlp ffmpeg

      - name: Download and Upload
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          KW=$(head -n 1 README.md)
          if [ -z "$KW" ]; then echo "README empty"; exit 1; fi

          echo "âœ… Searching for: $KW"
          
          # Use the 'web' extractor to avoid bot detection
          yt-dlp "ytsearch1:$KW" --extractor-args "youtube:player-client=web" --get-title --get-id > meta.txt
          TITLE=$(sed -n '1p' meta.txt)
          YT_ID=$(sed -n '2p' meta.txt)
          FILE_NAME="${YT_ID}.mp4"

          # Use a 'user-agent' to look like a real browser
          yt-dlp "https://www.youtube.com/watch?v=$YT_ID" \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -f "mp4[height<=720]" -o "$FILE_NAME"

          gh release create "v1" --title "Podcast Episodes" --notes "Video Storage" || echo "Release exists"
          gh release upload "v1" "$FILE_NAME" --clobber

          URL="https://github.com/feddedz/potify/releases/download/v1/$FILE_NAME"
          DATE=$(date -R)
          ITEM="<item><title>$TITLE</title><pubDate>$DATE</pubDate><enclosure url=\"$URL\" type=\"video/mp4\"/><guid>$YT_ID</guid></item>"
          sed -i "//a $ITEM" feed.xml

      - name: Save Feed
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add feed.xml
          git commit -m "Added video for: $(head -n 1 README.md)" || echo "No changes"
          git push
